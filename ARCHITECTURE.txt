ARCHITECTURE OVERVIEW
=====================

ASCII sketch
------------

        ┌──────────────┐        HTTP           ┌───────────────┐
User →  │ HTTP Server  │  /ask, /ui, health →  │   APIAgent    │
        │ (internal/app│---------------------->│ (routes + bus)│
        │    /http.go) │                       └──────┬────────┘
        └───────┬──────┘                              │ bus.Send()
                │                                      │
                │                         ┌────────────▼──────────┐
                │                         │        Bus             │
                │                         │  (pub/sub channels)    │
                │                         └────┬───────────┬──────┘
                │                              │           │
                │                              │           │
                │                     ┌────────▼───┐   ┌───▼────────┐
                │                     │ Inspector  │   │  Planner    │
                │                     └────────────┘   │  (reads     │
                │                                      │ definitions │
                │                                      │ pipelines,  │
                │                                      │ intents)    │
                │                                      └─────┬───────┘
                │                                            │ selects tools
                │                                            │ and params
                │                                ┌───────────▼───────────┐
                │                                │ Tools Runner (HTTP)   │
                │                                │ internal/tools/*.go   │
                │                                │ → executes YAML tools │
                │                                │ → adds headers (env)  │
                │                                │ → calls external svcs │
                │                                └───────────┬───────────┘
                │                                            │ responses
                │                         ┌──────────────────▼─────────────────┐
                │                         │ Verifier (guardrails)               │
                │                         └──────────────────┬─────────────────┘
                │                                            │
                │                         ┌──────────────────▼─────────────────┐
                │                         │ Analyst (LLM summary/explanations) │
                │                         │  → LLM client: Ollama/OpenAI       │
                │                         └──────────────────┬─────────────────┘
                │                                            │
                ▼                                            ▼
      ┌─────────────────┐                          ┌─────────────────────┐
      │ UIStore (/ui*)  │                          │ External Services   │
      │ templates/ui/*  │                          │ (mock banking, etc) │
      └─────────────────┘                          └─────────────────────┘


Mermaid diagram (source)
------------------------
The same diagram in Mermaid format is stored at docs/architecture.mmd and is embedded below for convenience.

```mermaid
flowchart LR
  user[User/Client]
  subgraph app[App]
    http[HTTP Server\ninternal/app/http.go]
    api[APIAgent\ninternal/agent/api_agent.go]
    bus[(Bus\ninternal/bus/bus.go)]
    inspector[Inspector]
    planner[Planner\nreads definitions]
    verifier[Verifier\n(guard rails)]
    analyst[Analyst\nLLM-assisted]
    uistore[UI Store\n/templates/ui/*]
  end

  subgraph cfg[Config]
    ytools[definitions/tools/*.yaml]
    ypipes[definitions/pipelines/*.yaml]
    yintents[definitions/intents/*.yaml]
    env[Env (.env → internal/config/env.go)]
  end

  subgraph llm[LLM]
    ollama[OllamaClient\ninternal/llm/ollama_client.go]
    openai[OpenAIClient\ninternal/llm/openai_client.go]
  end

  subgraph ext[External Services]
    banking[Banking/Mocks\ninternal/mocks/*]
  end

  user --> http
  http --> api
  api --> bus
  bus --> inspector
  bus --> planner
  bus --> verifier
  bus --> analyst

  planner -->|selects steps| toolsrunner

  subgraph toolsrunner[Tools Runner]
    execute[Execute HTTP tools\ninternal/tools/execute.go]
    renderer[Render templates\ninternal/tools/renderer.go]
  end

  execute -->|HTTP| banking
  renderer --> execute

  analyst --> llm
  llm --> ollama
  llm --> openai

  http --> uistore
  cfg --> planner
  cfg --> api
  env --> http
  env --> llm
  env --> execute
```


How to generate PNG/SVG
-----------------------
We provide Makefile targets that use Mermaid CLI via Docker to render the diagram from docs/architecture.mmd:

1) Generate SVG:
   make diagram-svg

2) Generate PNG:
   make diagram-png

Outputs will be written to docs/architecture.svg and docs/architecture.png respectively.
